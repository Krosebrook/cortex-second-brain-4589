# =============================================================================
# CODEQL SECURITY ANALYSIS
# =============================================================================
# Automated security code scanning using GitHub CodeQL
# Documentation: https://codeql.github.com/docs/
# =============================================================================

name: CodeQL Security Analysis

on:
  push:
    branches:
      - main
      - master
      - develop
  pull_request:
    branches:
      - main
      - master
  schedule:
    # Run weekly on Sunday at 00:00 UTC
    - cron: '0 0 * * 0'
  workflow_dispatch:

permissions:
  actions: read
  contents: read
  security-events: write

jobs:
  # ===========================================================================
  # CodeQL Analysis
  # ===========================================================================
  analyze:
    name: Analyze Code
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    strategy:
      fail-fast: false
      matrix:
        language:
          - javascript-typescript
        # Add more languages as needed:
        # - python
        # - java
        # - csharp
        # - go
        # - ruby
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          # Custom queries for enhanced security checks
          queries: +security-extended,security-and-quality
          # Config file for additional customization
          config: |
            name: "TESSA CodeQL Config"
            disable-default-queries: false
            queries:
              - uses: security-extended
              - uses: security-and-quality
            paths-ignore:
              - 'node_modules'
              - 'dist'
              - '**/*.test.ts'
              - '**/*.test.tsx'
              - '**/*.spec.ts'
              - '**/*.spec.tsx'
              - 'coverage'
              - '.github'

      # For compiled languages, autobuild attempts to build the project
      # For interpreted languages like JavaScript/TypeScript, this is optional
      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{ matrix.language }}"
          # Upload results to GitHub Security tab
          upload: true
          # Output SARIF file for external processing
          output: sarif-results
          
      - name: Upload SARIF as artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sarif-results-${{ matrix.language }}
          path: sarif-results
          retention-days: 30

  # ===========================================================================
  # Dependency Review (for PRs)
  # ===========================================================================
  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          # Fail on high and critical vulnerabilities
          fail-on-severity: high
          # Allow specific licenses
          allow-licenses: MIT, Apache-2.0, BSD-2-Clause, BSD-3-Clause, ISC, 0BSD
          # Deny copyleft licenses in production dependencies
          deny-licenses: GPL-2.0, GPL-3.0, AGPL-3.0
          # Comment on PR with results
          comment-summary-in-pr: always
          # Warn on these licenses but don't fail
          warn-only: true

  # ===========================================================================
  # Secret Scanning (additional layer)
  # ===========================================================================
  secret-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Scan for secrets with Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}
        continue-on-error: true

      - name: TruffleHog Secret Scan
        uses: trufflesecurity/trufflehog@main
        with:
          extra_args: --only-verified
        continue-on-error: true

  # ===========================================================================
  # SAST with Semgrep
  # ===========================================================================
  semgrep:
    name: Semgrep SAST
    runs-on: ubuntu-latest
    
    container:
      image: semgrep/semgrep
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Semgrep
        run: |
          semgrep ci \
            --sarif \
            --output=semgrep-results.sarif \
            --config=auto \
            --config=p/security-audit \
            --config=p/secrets \
            --config=p/typescript \
            --config=p/react
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
        continue-on-error: true

      - name: Upload Semgrep SARIF
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: semgrep-results.sarif
          category: semgrep
        continue-on-error: true

  # ===========================================================================
  # Security Summary Report
  # ===========================================================================
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [analyze, dependency-review, secret-scan, semgrep]
    if: always()
    
    steps:
      - name: Create security summary
        run: |
          echo "## ðŸ”’ Security Analysis Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Analysis Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| CodeQL Analysis | ${{ needs.analyze.result == 'success' && 'âœ… Passed' || needs.analyze.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Review | ${{ needs.dependency-review.result == 'success' && 'âœ… Passed' || needs.dependency-review.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Secret Scanning | ${{ needs.secret-scan.result == 'success' && 'âœ… Passed' || needs.secret-scan.result == 'skipped' && 'â­ï¸ Skipped' || 'âš ï¸ Warnings' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Semgrep SAST | ${{ needs.semgrep.result == 'success' && 'âœ… Passed' || needs.semgrep.result == 'skipped' && 'â­ï¸ Skipped' || 'âš ï¸ Warnings' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Review findings in the **Security** tab" >> $GITHUB_STEP_SUMMARY
          echo "2. Check **Code scanning alerts** for detailed issues" >> $GITHUB_STEP_SUMMARY
          echo "3. Review **Dependabot alerts** for vulnerable dependencies" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“š [Security Documentation](.github/SECURITY.md)" >> $GITHUB_STEP_SUMMARY

# =============================================================================
# CONFIGURATION NOTES
# =============================================================================
#
# Required Secrets (Optional for enhanced scanning):
# --------------------------------------------------
# - SEMGREP_APP_TOKEN: For Semgrep cloud integration
# - GITLEAKS_LICENSE: For Gitleaks enterprise features
#
# CodeQL Languages Supported:
# ---------------------------
# - javascript-typescript (includes both JS and TS)
# - python
# - java
# - csharp
# - go
# - ruby
# - cpp
# - swift
#
# Query Suites:
# -------------
# - security-extended: More security queries beyond default
# - security-and-quality: Security + code quality queries
# - security-experimental: Bleeding edge security queries
#
# Customization:
# --------------
# 1. Add custom queries in .github/codeql/custom-queries/
# 2. Reference them in the queries config above
# 3. Create qlpack.yml for custom query packs
#
# Viewing Results:
# ----------------
# 1. Go to Security tab in GitHub
# 2. Click "Code scanning alerts"
# 3. Filter by tool (CodeQL, Semgrep, etc.)
# 4. Review and dismiss/fix alerts
#
# Best Practices:
# ---------------
# - Review alerts promptly
# - Dismiss false positives with reason
# - Create issues for complex fixes
# - Monitor weekly scan results
#
# =============================================================================
