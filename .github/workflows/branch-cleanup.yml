# =============================================================================
# AUTOMATIC BRANCH CLEANUP
# =============================================================================
# Automatically deletes branches after pull requests are merged
# Documentation: https://github.com/jessfraz/branch-cleanup-action
# =============================================================================

name: Branch Cleanup

on:
  pull_request:
    types: [closed]
  
  # Allow manual trigger for cleanup
  workflow_dispatch:
    inputs:
      dry-run:
        description: 'Run in dry-run mode (no deletions)'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: write
  pull-requests: read

jobs:
  # ===========================================================================
  # Delete Merged Branch
  # ===========================================================================
  delete-merged-branch:
    name: Delete Merged Branch
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true
    
    steps:
      - name: Delete branch
        uses: jessfraz/branch-cleanup-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ===========================================================================
  # Manual Cleanup of Stale Branches
  # ===========================================================================
  cleanup-stale-branches:
    name: Cleanup Stale Branches
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Find and cleanup stale branches
        run: |
          echo "## ðŸ§¹ Stale Branch Cleanup Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Get default branch
          DEFAULT_BRANCH=$(git remote show origin | grep 'HEAD branch' | cut -d' ' -f5)
          echo "Default branch: $DEFAULT_BRANCH"
          
          # List all remote branches except main/master
          echo "### Branches Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          STALE_BRANCHES=()
          
          # Find branches that have been merged
          for branch in $(git branch -r --merged origin/$DEFAULT_BRANCH | grep -v "HEAD\|$DEFAULT_BRANCH"); do
            branch_name=$(echo $branch | sed 's|origin/||')
            
            # Skip protected branches
            if [[ "$branch_name" == "main" ]] || [[ "$branch_name" == "master" ]] || [[ "$branch_name" == "develop" ]]; then
              continue
            fi
            
            # Get last commit date
            last_commit_date=$(git log -1 --format="%at" $branch)
            current_date=$(date +%s)
            days_old=$(( ($current_date - $last_commit_date) / 86400 ))
            
            # If branch is merged and older than 7 days
            if [ $days_old -gt 7 ]; then
              STALE_BRANCHES+=("$branch_name")
              echo "- \`$branch_name\` - merged, $days_old days old" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ ${#STALE_BRANCHES[@]} -eq 0 ]; then
            echo "âœ… **No stale branches found!**" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi
          
          echo "### Found ${#STALE_BRANCHES[@]} stale branch(es)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          DRY_RUN="${{ github.event.inputs.dry-run }}"
          
          if [ "$DRY_RUN" == "true" ]; then
            echo "ðŸ” **DRY RUN MODE** - No branches will be deleted" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The following branches would be deleted:" >> $GITHUB_STEP_SUMMARY
            for branch in "${STALE_BRANCHES[@]}"; do
              echo "- \`$branch\`" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "ðŸ—‘ï¸ **Deleting stale branches:**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            for branch in "${STALE_BRANCHES[@]}"; do
              echo "Deleting branch: $branch"
              if git push origin --delete "$branch" 2>&1; then
                echo "âœ… Deleted: \`$branch\`" >> $GITHUB_STEP_SUMMARY
              else
                echo "âŒ Failed to delete: \`$branch\`" >> $GITHUB_STEP_SUMMARY
              fi
            done
          fi

# =============================================================================
# CONFIGURATION GUIDE
# =============================================================================
#
# Automatic Cleanup:
# ------------------
# When a pull request is merged, the branch is automatically deleted.
# This happens immediately after the merge completes.
#
# Protected Branches:
# -------------------
# The following branches are never deleted:
# - main
# - master  
# - develop
#
# Manual Cleanup:
# ---------------
# Run this workflow manually to cleanup stale merged branches:
# 1. Go to Actions > Branch Cleanup
# 2. Click "Run workflow"
# 3. Enable "dry-run" to test without deleting branches
# 4. Run without dry-run to actually delete stale branches
#
# Stale Branch Definition:
# ------------------------
# A branch is considered stale if:
# - It has been merged into the default branch
# - The last commit is older than 7 days
# - It's not a protected branch (main/master/develop)
#
# Manual Branch Deletion:
# -----------------------
# To delete branches manually via CLI:
# 
# # Delete local branch
# git branch -d feature-branch
# 
# # Delete remote branch
# git push origin --delete feature-branch
# 
# # List merged branches
# git branch --merged main
# 
# # Cleanup local references to deleted remote branches
# git fetch --prune
#
# =============================================================================
