# =============================================================================
# RELEASE-PLEASE WORKFLOW
# =============================================================================
# Alternative automated release workflow using Google's release-please
# Maintains release PRs that auto-update with each conventional commit
# Documentation: https://github.com/google-github-actions/release-please-action
# =============================================================================

name: Release Please

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    name: Release Please
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      version: ${{ steps.release.outputs.version }}
      upload_url: ${{ steps.release.outputs.upload_url }}

    steps:
      - name: Run Release Please
        id: release
        uses: google-github-actions/release-please-action@v4
        with:
          release-type: node
          token: ${{ secrets.GITHUB_TOKEN }}
          # Changelog configuration
          changelog-types: |
            [
              {"type": "feat", "section": "âœ¨ Features", "hidden": false},
              {"type": "fix", "section": "ðŸ› Bug Fixes", "hidden": false},
              {"type": "perf", "section": "âš¡ Performance", "hidden": false},
              {"type": "docs", "section": "ðŸ“š Documentation", "hidden": false},
              {"type": "refactor", "section": "â™»ï¸ Refactoring", "hidden": false},
              {"type": "test", "section": "ðŸ§ª Tests", "hidden": false},
              {"type": "build", "section": "ðŸ”¨ Build", "hidden": false},
              {"type": "ci", "section": "ðŸ”§ CI/CD", "hidden": false},
              {"type": "chore", "section": "ðŸ§¹ Chores", "hidden": true},
              {"type": "style", "section": "ðŸ’„ Styling", "hidden": true}
            ]
          # Pull request configuration
          pull-request-title-pattern: "chore(release): ${version}"
          pull-request-header: |
            :robot: This PR was automatically created by release-please.
            
            When merged, it will create a new release with the version shown in the title.
          include-v-in-tag: true

  # ===========================================================================
  # Build and Validate on Release
  # ===========================================================================
  build:
    name: Build Release
    runs-on: ubuntu-latest
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Build application
        run: npm run build
        env:
          NODE_ENV: production

      - name: Run tests
        run: npm test -- --run

      - name: Create release summary
        run: |
          echo "## ðŸŽ‰ Release ${{ needs.release-please.outputs.version }} Created!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** ${{ needs.release-please.outputs.tag_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[View Release](https://github.com/${{ github.repository }}/releases/tag/${{ needs.release-please.outputs.tag_name }})" >> $GITHUB_STEP_SUMMARY

# =============================================================================
# HOW RELEASE-PLEASE WORKS
# =============================================================================
#
# 1. On every push to main, release-please analyzes conventional commits
# 2. It creates/updates a "Release PR" with version bump and changelog
# 3. The PR accumulates all changes until you're ready to release
# 4. When you merge the Release PR, a GitHub Release is created
#
# Benefits over manual releases:
# - Always up-to-date Release PR shows what will be released
# - Version is calculated from commit history
# - CHANGELOG.md is automatically maintained
# - No manual version bumping required
#
# CONVENTIONAL COMMITS CHEAT SHEET:
#
# Version Bumps:
# - feat: â†’ Minor version (1.0.0 â†’ 1.1.0)
# - fix:  â†’ Patch version (1.0.0 â†’ 1.0.1)
# - feat!: or BREAKING CHANGE â†’ Major version (1.0.0 â†’ 2.0.0)
#
# No Version Bump:
# - docs:, style:, refactor:, test:, chore:, ci:, build:
#
# Examples:
# - "feat: add dark mode support" â†’ 1.1.0
# - "fix(auth): handle expired tokens" â†’ 1.0.1
# - "feat!: redesign API responses" â†’ 2.0.0
#
# =============================================================================
